(window.webpackJsonp=window.webpackJsonp||[]).push([[132],{729:function(s,t,a){"use strict";a.r(t);var n=a(24),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h6",{attrs:{id:"原文-掘金"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原文-掘金"}},[s._v("#")]),s._v(" 原文 "),a("a",{attrs:{href:"https://juejin.cn/post/7171002835016892453",target:"_blank",rel:"noopener noreferrer"}},[s._v("掘金"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"markdown-body cache"},[a("h3",{attrs:{id:"从一道题目出发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从一道题目出发"}},[s._v("#")]),s._v(" 从一道题目出发")]),s._v(" "),a("p",[s._v("今天看到一道面试题，是关于"),a("code",[s._v("async/await")]),s._v("、"),a("code",[s._v("promise")]),s._v("和"),a("code",[s._v("setTimeout")]),s._v("的执行顺序，题目如下：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async1 start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'asnyc1 end'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("gt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeOut'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("reslove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reslove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script end'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("我给出的答案：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("script "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v("\nasync1 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v("\nasync2\nasnyc1 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// x")]),s._v("\npromise1\nscript "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\npromise2\nsetTimeOut\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("正确的答案：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("script "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v("\nasync1 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v("\nasync2\npromise1\nscript "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\nasnyc1 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\npromise2\nsetTimeOut\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("为什么"),a("code",[s._v("promise1")]),s._v("比"),a("code",[s._v("asnyc1 end")]),s._v("先出来呢？带着这个疑问，我去了解了一下"),a("strong",[s._v("事件循环机制")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"js-eventloop-事件循环机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#js-eventloop-事件循环机制"}},[s._v("#")]),s._v(" js EventLoop 事件循环机制")]),s._v(" "),a("p",[s._v("JavaScript的事件分两种:")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("宏任务(macro-task)")]),a("th",[s._v("微任务(micro-task)")])])]),a("tbody",[a("tr",[a("td",[s._v("script")]),a("td",[s._v("promise.[ then/catch/finally ]((非new Promise))")])]),a("tr",[a("td",[s._v("setTimeout")]),a("td",[s._v("process.nextTick(Node.js 环境)")])]),a("tr",[a("td",[s._v("setInterval")]),a("td",[s._v("MutaionOberver（浏览器环境）")])]),a("tr",[a("td",[s._v("setImmediate(Node.js 环境)")]),a("td",[s._v("Object.observe")])]),a("tr",[a("td",[s._v("IO操作")]),a("td",[s._v("x")])]),a("tr",[a("td",[s._v("UI交互事件")]),a("td",[s._v("x")])]),a("tr",[a("td",[s._v("postMessage")]),a("td",[s._v("x")])]),a("tr",[a("td",[s._v("MessageChannel")]),a("td",[s._v("x")])])])]),s._v(" "),a("p",[s._v("事件的执行顺序，是先执行宏任务，然后执行微任务，这个是基础，任务可以有同步任务和异步任务，同步的进入主线程，异步的进入Event Table并注册函数，异步事件完成后，会将回调函数放入Event Queue中(宏任务和微任务是不同的Event Queue)，同步任务执行完成后，会从Event Queue中读取事件放入主线程执行，回调函数中可能还会包含不同的任务，因此会循环执行上述操作。")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("注意：")]),s._v(" "),a("code",[s._v("setTimeOut")]),s._v("并不是直接的把你的回掉函数放进上述的异步队列中去，而是在定时器的时间到了之后，把回掉函数放到执行异步队列中去。如果此时这个队列已经有很多任务了，那就排在他们的后面。这也就解释了为什么"),a("code",[s._v("setTimeOut")]),s._v("为什么不能精准的执行的问题了。"),a("code",[s._v("setTimeOut")]),s._v("执行需要满足两个条件：")]),s._v(" "),a("ol",[a("li",[s._v("主进程必须是空闲的状态，如果到时间了，主进程不空闲也不会执行你的回调函数")]),s._v(" "),a("li",[s._v("这个回调函数需要等到插入异步队列时前面的异步函数都执行完了，才会执行")])])]),s._v(" "),a("h3",{attrs:{id:"promise、async-await"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promise、async-await"}},[s._v("#")]),s._v(" promise、async/await")]),s._v(" "),a("p",[s._v("首先，"),a("code",[s._v("new Promise")]),s._v("是同步的任务，会被放到主进程中去立即执行。而"),a("code",[s._v(".then()")]),s._v("函数是异步任务会放到异步队列中去，那什么时候放到异步队列中去呢？当你的"),a("code",[s._v("promise")]),s._v("状态结束的时候，就会立即放进异步队列中去了。")]),s._v(" "),a("p",[a("strong",[s._v("带"),a("code",[s._v("async")]),s._v("关键字的函数会返回一个"),a("code",[s._v("promise")]),s._v("对象")]),s._v("，如果里面没有"),a("code",[s._v("await")]),s._v("，执行起来等同于普通函数；如果没有"),a("code",[s._v("await")]),s._v("，"),a("code",[s._v("async")]),s._v("函数并没有很厉害是不是。")]),s._v(" "),a("p",[a("code",[s._v("await")]),s._v(" 关键字要在 "),a("code",[s._v("async")]),s._v(" 关键字函数的内部，"),a("code",[s._v("await")]),s._v(" 写在外面会报错；"),a("code",[s._v("await")]),s._v("如同他的语意，就是在等待，等待右侧的表达式完成。此时的"),a("code",[s._v("await")]),s._v("会让出线程，阻塞"),a("code",[s._v("async")]),s._v("内后续的代码，先去执行"),a("code",[s._v("async")]),s._v("外的代码。等外面的同步代码执行完毕，才会执行里面的后续代码。就算"),a("code",[s._v("await")]),s._v("的不是"),a("code",[s._v("promise")]),s._v("对象，是一个同步函数，也会等这样操作。")]),s._v(" "),a("h3",{attrs:{id:"流程梳理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程梳理"}},[s._v("#")]),s._v(" 流程梳理")]),s._v(" "),a("p",[s._v("我们整体再梳理一下上面代码执行的流程：")]),s._v(" "),a("blockquote",[a("ol",[a("li",[s._v("整个代码片段（script）作为一个宏任务执行"),a("code",[s._v("console.log('script start')")]),s._v("，输出"),a("code",[s._v("script start")]),s._v("；")]),s._v(" "),a("li",[s._v("执行"),a("code",[s._v("setTimeout")]),s._v("，是一个异步动作，放入宏任务异步队列中；")]),s._v(" "),a("li",[s._v("执行"),a("code",[s._v("async1()")]),s._v("，输出"),a("code",[s._v("async1 start")]),s._v("，继续向下执行；")]),s._v(" "),a("li",[s._v("执行"),a("code",[s._v("async2()")]),s._v("，输出"),a("code",[s._v("async2")]),s._v("，并返回了一个"),a("code",[s._v("promise")]),s._v("对象，"),a("code",[s._v("await")]),s._v("让出了线程，把返回的"),a("code",[s._v("promise")]),s._v("加入了微任务异步队列，所以"),a("code",[s._v("async1()")]),s._v("下面的代码也要等待上面完成后继续执行;")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("new Promise")]),s._v("，输出"),a("code",[s._v("promise1")]),s._v("，然后将"),a("code",[s._v("resolve()")]),s._v("放入微任务异步队列；")]),s._v(" "),a("li",[s._v("执行"),a("code",[s._v("console.log('script end')")]),s._v("，输出"),a("code",[s._v("script end")]),s._v("；")]),s._v(" "),a("li",[s._v("到此同步的代码就都执行完成了，然后去微任务异步队列里去获取任务")]),s._v(" "),a("li",[s._v("接下来执行"),a("code",[s._v("resolve")]),s._v("（"),a("code",[s._v("async2")]),s._v("返回的"),a("code",[s._v("promise")]),s._v("返回的），输出了"),a("code",[s._v("async1 end")]),s._v("；")]),s._v(" "),a("li",[s._v("然后执行"),a("code",[s._v("resolve（new Promise的）")]),s._v("，输出了"),a("code",[s._v("promise2")]),s._v("；")]),s._v(" "),a("li",[s._v("最后执行"),a("code",[s._v("setTimeout")]),s._v("，输出了"),a("code",[s._v("settimeout")]),s._v("。")])])]),s._v(" "),a("p",[s._v("在第"),a("code",[s._v("4")]),s._v("步中， "),a("code",[s._v("await")]),s._v(" 这里有一个机制， 就是 "),a("code",[s._v("await")]),s._v(" 的等待， 不会阻塞外部函数的执行， 而 "),a("code",[s._v("await")]),s._v(" 等待的 如果是一个 "),a("code",[s._v("Promise")]),s._v(" 则 "),a("code",[s._v("Promise")]),s._v(" 里面的代码还是同步执行， 如果不是 "),a("code",[s._v("Promise")]),s._v(" ，就会使用 "),a("code",[s._v("Promise.resolve")]),s._v(" 来进行封装， 这里的 "),a("code",[s._v("async2")]),s._v(" 是一个 "),a("code",[s._v("async")]),s._v(" 方法， 里面的 打印会同步执行， 而 "),a("code",[s._v("await async2()")]),s._v(" 后面的代码 会放到微任务队列中的第一个位置，等待外部同步代码执行完毕以后再执行。")]),s._v(" "),a("p",[s._v("所以我知道了"),a("code",[s._v("script end")]),s._v("为什么会优先于"),a("code",[s._v("async1 end")]),s._v("输出。")])])])}),[],!1,null,null,null);t.default=e.exports}}]);
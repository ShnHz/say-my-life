(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{477:function(e,t,n){},583:function(e,t,n){"use strict";var a=n(477);n.n(a).a},645:function(e,t,n){"use strict";n.r(t);n(25),n(93),n(131),n(46),n(194),n(39),n(63),n(13),n(98),n(132),n(37),n(94),n(38);var a=n(144),r=(n(140),n(73)),s=n(565),i=n.n(s),o={data:function(){return{type:null,data:[],container:{file:null},hashPercentage:0}},computed:{totalPercentage:function(){var e=this.data.length;if(this.container.file&&e){var t=this.data.reduce((function(e,t){return t.percentage*t.size/100+e}),0),n=this.container.file.size;return parseInt(t/n*100)}return 0}},methods:{uploadClick:function(){this.$refs.fileInput.dispatchEvent(new MouseEvent("click"))},pauseClick:function(){this.type="pause",this.data.forEach((function(e){e.source.cancel("取消请求")}))},continueClick:function(){"pause"==this.type&&(this.type="uploading",this.handleUpload())},handleUpload:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){var n,a,r,s;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.container.file){t.next=2;break}return t.abrupt("return");case 2:if(n=e.createFileChunk(e.container.file),!e.container.hash){t.next=7;break}t.t0=e.container.hash,t.next=10;break;case 7:return t.next=9,e.calculateHash(n);case 9:t.t0=t.sent;case 10:return e.container.hash=t.t0,e.type="uploading",t.next=14,e.verifyUpload();case 14:if(a=t.sent,r=a.shouldUpload,s=a.createUploadedList,!r){t.next=23;break}return e.data=n.map((function(t,n){var a=t.file,r=s.includes(e.container.hash+"-"+n);return{index:n,chunk:a,fileHash:e.container.hash,hash:e.container.hash+"-"+n,size:a.size,percentage:r?100:0,source:i.a.CancelToken.source(),uploaded:r}})),t.next=21,e.uploadChunks();case 21:t.next=24;break;case 23:e.type=null;case 24:case"end":return t.stop()}}),t)})))()},handleFileChange:function(e){var t=Object(a.a)(e.target.files,1)[0];t&&(this.container.file=t,this.container.hash=null,this.hashPercentage=0,this.data=[],this.handleUpload())},createFileChunk:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10485760,n=[],a=0;a<e.size;)n.push({file:e.slice(a,a+t)}),a+=t;return n},calculateHash:function(e){var t=this;return new Promise((function(n){t.container.worker=new Worker("/js/creat-file-hash.js"),t.container.worker.postMessage({fileChunkList:e}),t.container.worker.onmessage=function(e){var a=e.data,r=a.percentage,s=a.hash;t.hashPercentage=r,s&&n(s)}}))},uploadChunks:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.data.filter((function(e){return!e.uploaded})).map((function(t){var n=t.chunk,a=t.hash,r=t.index,s=t.fileHash,i=t.source,o=new FormData;return o.append("chunk",n),o.append("hash",a),o.append("fileHash",s),o.append("filename",e.container.file.name),e.$http.post("http://localhost:3000/other/bigFileUploadAndResume/upload?hash=".concat(a),o,{onUploadProgress:e.handlerProgress(e.data[r]),cancelToken:i.token})})),t.next=3,Promise.all(n);case 3:return t.next=5,e.mergeRequest();case 5:case"end":return t.stop()}}),t)})))()},mergeRequest:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.$http.post("http://localhost:3000/other/bigFileUploadAndResume/merge",{filename:e.container.file.name,fileHash:e.container.hash,size:10485760}).then((function(t){e.$message({message:"上传成功",type:"success"}),e.type=null}));case 2:case"end":return t.stop()}}),t)})))()},verifyUpload:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.$http.get("http://localhost:3000/other/bigFileUploadAndResume/hasfile",{params:{filename:e.container.file.name,fileHash:e.container.hash}}).then((function(t){(n=t.data).shouldUpload||e.$message({message:"上传成功",type:"success"})}));case 2:return t.abrupt("return",n);case 3:case"end":return t.stop()}}),t)})))()},handlerProgress:function(e){return function(t){e.percentage=parseInt(String(t.loaded/t.total*100))}}}},c=(n(583),n(24)),l=Object(c.a)(o,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"the-big-file-upload-and-resume-wrap"},[n("div",{staticClass:"fn-wrap"},[n("input",{ref:"fileInput",attrs:{type:"file"},on:{change:e.handleFileChange}}),e._v(" "),n("el-button",{attrs:{type:"primary",size:"small",disabled:null!=e.type},on:{click:e.uploadClick}},[n("i",{staticClass:"el-icon-upload"}),e._v(" 单击上传\n        ")]),e._v(" "),n("el-button",{attrs:{size:"small",disabled:"uploading"!=e.type},on:{click:e.pauseClick}},[n("i",{staticClass:"el-icon-video-pause"}),e._v(" 暂停\n        ")]),e._v(" "),n("el-button",{attrs:{size:"small",disabled:"pause"!=e.type},on:{click:e.continueClick}},[n("i",{staticClass:"el-icon-video-play"}),e._v(" 继续\n        ")])],1),e._v(" "),n("el-progress",{attrs:{"show-text":!1,"stroke-width":6,percentage:e.hashPercentage,"stroke-linecap":"butt"}}),e._v(" "),n("el-progress",{attrs:{"show-text":!1,"stroke-width":6,percentage:e.totalPercentage,"stroke-linecap":"butt"}}),e._v(" "),n("el-table",{staticStyle:{width:"100%"},attrs:{data:e.data,stripe:""}},[n("el-table-column",{attrs:{prop:"index",label:"index",width:"80"}}),e._v(" "),n("el-table-column",{attrs:{prop:"size",label:"size",width:"120"}}),e._v(" "),n("el-table-column",{attrs:{label:"filename"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n                "+e._s(e.container.file.name)+"\n            ")]}}])}),e._v(" "),n("el-table-column",{attrs:{prop:"hash",label:"hash",width:"300"}}),e._v(" "),n("el-table-column",{attrs:{prop:"percentage",label:"percentage",width:"300"},scopedSlots:e._u([{key:"default",fn:function(e){return[n("el-progress",{attrs:{percentage:e.row.percentage}})]}}])})],1)],1)}),[],!1,null,"641633e2",null);t.default=l.exports}}]);